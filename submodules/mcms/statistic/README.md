# mcms-statistic
Модуль статистики - делаем на mysql mariadb, и предполагаем что модели для разных баз можно будет разные делать

## Выкуп подписок (cron скрипт).
команда 
```bash
php yii statistic/buyout
```
Вкраце выкуп происходит следующим образом (это описание добавлю ещё в ридми и в phpdoc).

Сначала отбираются все подписки на выкуп и инвесторы, способные выкупать подписки (проверка баланса, статуса и т.д.).

Далее при помощи `$query->batch()` обрабатываем пачками выборку. Следующий блок выполняется для каждой пачки:

* Для каждой подписки присваиваем инвестора. Как происходит присвоение:
  * Для начала рандомом выбираем инвестора. Если инвестору хватает средств на эту подписку, то используем этого инвестора. Если инвестору не хватает, то выбираем рандомом другого инвестора (при выборе первый не должен участвовать уже).  так далее пока не будет выбран подходящий инвестор. Если инвесторы не найдены для подписки - в консоль упадет сообщение об этом. Данная подписка в этот раз выкуплена не будет, будет ждать следующего выкупа (запуска крона).
* Потом для каждого инвестора списываем деньги через апи investorBuyout модуля payments. Получается списываем сумму, которая внутри этой пачки `batch()` присвоилась данному инвестору подписками. 
* После каждого списания создаём записи в sold_subscriptions (при помощи batchInsert) 
* обновляем везде инфу по подписке.
